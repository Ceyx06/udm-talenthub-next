generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(APPLICANT)
  createdAt DateTime @default(now())
}

model Vacancy {
  id           String        @id @default(cuid())
  title        String
  college      String
  status       String
  requirements String
  description  String
  postedDate   DateTime      @default(now())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  applications Application[]

  @@index([status])
  @@index([college])
  @@map("vacancies")
}

model VacancyRequest {
  id                    String   @id @default(cuid())
  jobTitle              String
  college               String
  numberOfSlots         Int
  targetStartDate       DateTime
  minimumQualifications String   @db.Text
  justification         String   @db.Text

  status      String    @default("Pending")
  submittedBy String?
  submittedAt DateTime  @default(now())
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([college])
  @@index([submittedAt])
  @@map("vacancy_requests")
}

model Application {
  id        String  @id @default(cuid())
  vacancyId String
  vacancy   Vacancy @relation(fields: [vacancyId], references: [id], onDelete: Cascade)

  // Required fields
  fullName    String
  email       String
  phone       String
  coverLetter String
  resumeUrl   String

  status      String   @default("PENDING")
  appliedDate DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Personal Information
  firstName        String?
  middleName       String?
  lastName         String?
  contactNo        String?
  dob              DateTime?
  gender           String?
  civilStatus      String?
  presentAddress   String?
  permanentAddress String?
  nationality      String?
  idType           String?
  idNumber         String?

  // Position Information
  desiredPosition String?
  department      String?
  employmentType  String?

  // Education
  highestDegree String?
  trainingHours Int?
  licenseName   String?
  licenseNo     String?
  licenseExpiry DateTime?

  // JSON fields
  experiences Json? @default("[]")
  references  Json? @default("[]")

  // Document URLs
  pdsUrl        String?
  transcriptUrl String?
  trainingsUrl  String?
  employmentUrl String?

  // Application tracking
  signature String?
  signedAt  DateTime?
  qrCode    String?
  message   String?
  stage     String?   @default("APPLIED")

  // Stage dates
  endorsedDate     DateTime?
  endorsedBy       String?       // Track who endorsed
  
  // Dean Review Fields
  deanReviewedDate DateTime?     // When dean reviewed
  deanReviewedBy   String?       // Dean user id
  deanRemarks      String?       // Dean's comments
  
  employeeId       String?
  hiredAt          DateTime?
  interviewDate    DateTime?     // Main interview date
  demoDate         DateTime?     // Teaching demo date
  statusUpdatedAt  DateTime?

  // NEW: Additional Interview Details for Email
  interviewTime     String?      // Time of interview (e.g., "10:00 AM")
  interviewLocation String?      // Location of interview
  interviewType     String?      // Type (Panel, One-on-One, Virtual)
  interviewNotes    String?      // Additional notes for applicant

  // Evaluation
  evaluationScore Float?
  evaluationNotes String?
  rejectionReason String?
  
  // File status
  fileStatus String? @default("pending")

  // Relations
  interviews Interview[]
  evaluation Evaluation?

  @@index([vacancyId])
  @@index([email])
  @@index([status])
  @@index([stage])
  @@map("applications")
}

model Faculty {
  id             String    @id @default(cuid())
  name           String
  position       String
  type           String
  contract       String
  recommendation String
  actions        String
  renewals       Renewal[]
}

model Renewal {
  id                 String             @id @default(cuid())
  facultyName        String
  college            String?
  contractNo         String
  position           String
  deanRemarks        String
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  contractEndDate    DateTime?
  deanActedAt        DateTime?
  deanUserId         String
  facultyId          String
  statusUpdatedAt    DateTime?
  type               String
  deanRecommendation DeanRecommendation @default(PENDING)
  status             RenewalStatus      @default(PENDING_DEAN)
  faculty            Faculty            @relation(fields: [facultyId], references: [id], onDelete: Cascade)

  @@index([facultyId])
  @@index([status])
  @@map("renewals")
}

model Interview {
  id               String      @id @default(cuid())
  interviewId      String      @unique
  applicationId    String
  interviewDate    DateTime?
  teachingDemoDate DateTime?
  status           String      @default("Pending")
  notes            String?
  location         String?
  interviewers     String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  application      Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
  @@map("interviews")
}

model Contract {
  id              String      @id @default(cuid())
  contractNo      String      @unique
  evaluationId    String?     @unique
  evaluation      Evaluation? @relation(fields: [evaluationId], references: [id])
  
  facultyName     String
  email           String
  phone           String?
  college         String
  jobTitle        String
  position        String      // The rank from evaluation
  employmentType  String      @default("Full-time") // Full-time, Part-time
  
  ratePerHour     Float
  startDate       DateTime
  endDate         DateTime
  
  status          String      @default("Active") // Active, Expired, Pending Renewal
  
  createdBy       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([status])
  @@index([college])
  @@index([endDate])
  @@map("contracts")
}

enum UserRole {
  ADMIN
  HR
  DEAN
  APPLICANT
}

enum RenewalStatus {
  PENDING_DEAN
  APPROVED
  REJECTED
}

enum DeanRecommendation {
  PENDING
  RENEW
  NOT_RENEW
}

model Evaluation {
  id                    String      @id @default(cuid())
  applicationId         String      @unique
  application           Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

   // NEW: back-relation to all detailed rows for this evaluation
  items                 EvaluationItem[]
  
  // Scores by category
  educationalScore      Float       @default(0)
  experienceScore       Float       @default(0)
  professionalDevScore  Float       @default(0)
  technologicalScore    Float       @default(0)
  
  // Total and ranking
  totalScore            Float       @default(0)
  rank                  String?
  ratePerHour           Float?
  
  // Detailed scores (stored as JSON)
  detailedScores        Json?
  
  // Evaluation metadata
  evaluatedBy           String
  evaluatedAt           DateTime    @default(now())
  remarks               String?
  
  // Contract Queue fields
  contractStatus        String?     @default("pending")
  contractActionDate    DateTime?
  
  // Contract relation
  contract              Contract?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([applicationId])
  @@index([contractStatus])
  @@map("evaluations")
}

enum EvaluationFieldType {
  RADIO   // yes / no (Category 1.1)
  UNITS   // # of units / years (2.x, 3.1.x, 3.2.x, 3.3–3.6)
  SCALE   // 1–5 scale (4.1–4.4)
}

model EvaluationItem {
  id           String            @id @default(cuid())
  evaluationId String
  evaluation   Evaluation        @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  // Identification of which line in the form this is
  category     Int               // 1, 2, 3, 4
  subcategory  String            // e.g. "1.1", "3.2.1", "4.3"
  itemKey      String            // e.g. "c11_doctorate", "c321_trainingIntl"
  label        String?           // optional; you can also keep labels only in frontend/PDF config

  fieldType    EvaluationFieldType

  // User input
  yesNo        Boolean?          // for RADIO items (1 = yes, 0 = no)
  units        Float?            // # of years, # of books, # of 3-unit blocks, etc.
  scale        Int?              // 1–5 rating (Category 4.x)
  customPoints Float?            // cases like 1.1.c "Others please specify" where credit is editable

  // for transparency / debugging you can also store how it was scored
  creditPerUnit  Float?          // the official credit (e.g. 7, 5, 1.5, etc.)
  creditedPoints Float?          // final computed value (units × credit, or points for RADIO)

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([evaluationId])
  @@index([category])
  @@index([itemKey], name: "EvaluationItem_itemKey_idx")
}